<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>SNMP Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #e5e7eb; /* text-gray-200 */
        }
        #log-output::-webkit-scrollbar {
            width: 8px;
        }
        #log-output::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        #log-output::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        #log-output::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* --- Animations --- */
        @keyframes vibrate {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .vibrate {
            animation: vibrate 0.3s linear 2; /* Run animation twice */
        }
    </style>
</head>
<body class="bg-black text-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-400">SNMP Simulator</h1>

        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Left Panel: Control Panel -->
            <div class="lg:w-1/3 bg-gray-900 p-6 rounded-lg shadow-xl space-y-8">
                
                <!-- Section 1: Device Setup -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">1. Device Setup</h2>
                    <div>
                        <label for="num-devices" class="block text-sm font-medium text-gray-300">Number of Devices</label>
                        <input type="number" id="num-devices" value="5" class="mt-1 block w-full bg-gray-800 border-gray-700 rounded-md shadow-sm p-2 text-gray-100 focus:ring-blue-400 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="manager-ip" class="block text-sm font-medium text-gray-300">Manager IP</label>
                        <input type="text" id="manager-ip" value="192.168.1.1" class="mt-1 block w-full bg-gray-800 border-gray-700 rounded-md shadow-sm p-2 text-gray-100 focus:ring-blue-400 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="agent-prefix" class="block text-sm font-medium text-gray-300">Agent IP Prefix</label>
                        <input type="text" id="agent-prefix" value="192.168.1." class="mt-1 block w-full bg-gray-800 border-gray-700 rounded-md shadow-sm p-2 text-gray-100 focus:ring-blue-400 focus:border-blue-400">
                    </div>
                    <button id="start-sim-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md">Start Simulation</button>
                </div>

                <!-- Section 2: Polling Configuration -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">2. Polling Configuration</h2>
                    <div>
                        <label for="oids-to-poll" class="block text-sm font-medium text-gray-300">OIDs to Poll (one per line)</label>
                        <textarea id="oids-to-poll" rows="4" class="mt-1 block w-full bg-gray-800 border-gray-700 rounded-md shadow-sm p-2 text-gray-100 focus:ring-blue-400 focus:border-blue-400">1.3.6.1.2.1.1.1.0
1.3.6.1.2.1.1.3.0
1.3.6.1.2.1.2.2.1.8.1
1.3.6.1.2.1.2.2.1.8.2</textarea>
                    </div>
                    <div>
                        <label for="poll-interval" class="block text-sm font-medium text-gray-300">Polling Interval (ms)</label>
                        <input type="number" id="poll-interval" value="5000" class="mt-1 block w-full bg-gray-800 border-gray-700 rounded-md shadow-sm p-2 text-gray-100 focus:ring-blue-400 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="net-delay" class="block text-sm font-medium text-gray-300">Network Delay (ms)</label>
                        <input type="number" id="net-delay" value="150" class="mt-1 block w-full bg-gray-800 border-gray-700 rounded-md shadow-sm p-2 text-gray-100 focus:ring-blue-400 focus:border-blue-400">
                    </div>
                    <button id="start-poll-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md" disabled>Start Polling</button>
                    <button id="stop-poll-btn" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md" disabled>Stop Polling</button>
                </div>

                <!-- Section 3: Manual SET Operation -->
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-blue-300 border-b border-gray-700 pb-2">3. Manual SET Operation</h2>
                    <div>
                        <label for="set-ip" class="block text-sm font-medium text-gray-300">Device IP</label>
                        <input type="text" id="set-ip" placeholder="e.g., 192.168.1.101" class="mt-1 block w-full bg-gray-800 border-gray-700 rounded-md shadow-sm p-2 text-gray-100 focus:ring-blue-400 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="set-oid" class="block text-sm font-medium text-gray-300">OID to SET</label>
                        <input type="text" id="set-oid" value="1.3.6.1.2.1.1.5.0" class="mt-1 block w-full bg-gray-800 border-gray-700 rounded-md shadow-sm p-2 text-gray-100 focus:ring-blue-400 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="set-value" class="block text-sm font-medium text-gray-300">New Value</label>
                        <input type="text" id="set-value" placeholder="e.g., 'new-router-name'" class="mt-1 block w-full bg-gray-800 border-gray-700 rounded-md shadow-sm p-2 text-gray-100 focus:ring-blue-400 focus:border-blue-400">
                    </div>
                    <button id="send-set-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md" disabled>Send SET Request</button>
                </div>
            </div>

            <!-- Right Panel: Display -->
            <div class="lg:w-2/3 space-y-8">
                
                <!-- Network Map Section -->
                <div>
                    <h2 class="text-2xl font-semibold text-blue-300 mb-4">Network Map</h2>
                    <!-- Set container to relative and give it a fixed height for absolute positioning of children -->
                    <div id="network-map" class="bg-gray-900 p-6 rounded-lg shadow-xl flex items-center justify-center min-h-[400px] relative">
                        
                        <!-- Manager node, will be positioned absolute center -->
                        <div id="map-manager" class="transition-all duration-150 z-10">
                            <!-- JS will populate this -->
                        </div>
                        
                        <!-- Container for agents, will also be absolute to fill the parent -->
                        <div id="map-agents-container" class="absolute top-0 left-0 w-full h-full">
                             <div class="text-gray-400 italic absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                                 Press "Start Simulation" to create devices.
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Device Status Section -->
                <div>
                    <h2 class="text-2xl font-semibold text-blue-300 mb-4">Device Status</h2>
                    <div id="device-status-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <div class="text-gray-400 italic">Press "Start Simulation" to create devices.</div>
                    </div>
                </div>

                <!-- SNMP Log Section -->
                <div>
                    <h2 class="text-2xl font-semibold text-blue-300 mb-4">SNMP Log</h2>
                    <!-- Inverted colors: log is gray-800, body is black -->
                    <pre id="log-output" class="w-full h-96 bg-gray-800 text-sm text-gray-100 rounded-lg shadow-inner p-4 overflow-y-scroll font-mono"></pre>
                    <button id="clear-log-btn" class="mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md">Clear Log</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const devices = new Map();
        let managerIP = '';
        let pollingIntervalId = null;

        // --- Control Panel Elements ---
        const startSimBtn = document.getElementById('start-sim-btn');
        const startPollBtn = document.getElementById('start-poll-btn');
        const stopPollBtn = document.getElementById('stop-poll-btn');
        const sendSetBtn = document.getElementById('send-set-btn');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const numDevicesInput = document.getElementById('num-devices');
        const managerIpInput = document.getElementById('manager-ip');
        const agentPrefixInput = document.getElementById('agent-prefix');
        const oidsTextarea = document.getElementById('oids-to-poll');
        const pollIntervalInput = document.getElementById('poll-interval');
        const netDelayInput = document.getElementById('net-delay');
        const setIpInput = document.getElementById('set-ip');
        const setOidInput = document.getElementById('set-oid');
        const setValueInput = document.getElementById('set-value');
        
        // --- Display Panel Elements ---
        const deviceGrid = document.getElementById('device-status-grid');
        const logOutput = document.getElementById('log-output');
        const networkMap = document.getElementById('network-map');
        const mapManager = document.getElementById('map-manager');
        const mapAgentsContainer = document.getElementById('map-agents-container');

        // --- Device Class ---
        class Device {
            constructor(ip, type) {
                this.ip = ip;
                this.type = type;
                this.startTime = Date.now();
                this.mib = this.generateSimulatedMib();
                
                this.portStatus = {
                    '1.3.6.1.2.1.2.2.1.8.1': 'up',
                    '1.3.6.1.2.1.2.2.1.8.2': 'up',
                };
            }

            generateSimulatedMib() {
                const deviceId = this.ip.split('.').pop();
                return {
                    '1.3.6.1.2.1.1.1.0': `Simulated ${this.type} v${deviceId}.0`,
                    '1.3.6.1.2.1.1.2.0': '1.3.6.1.4.1.9999',
                    '1.3.6.1.2.1.1.3.0': () => (Date.now() - this.startTime) / 10,
                    '1.3.6.1.2.1.1.5.0': `${this.type.toLowerCase()}-${deviceId}`,
                    '1.3.6.1.2.1.1.6.0': 'Data Center, 1st Floor',
                };
            }

            get(oid) {
                if (this.mib[oid] && typeof this.mib[oid] === 'function') {
                    return Math.floor(this.mib[oid]());
                }
                
                if (this.portStatus.hasOwnProperty(oid)) {
                    return this.portStatus[oid];
                }

                if (this.mib.hasOwnProperty(oid)) {
                    return this.mib[oid];
                }

                return 'Error: No Such Object';
            }

            set(oid, value) {
                const writableOids = ['1.3.6.1.2.1.1.5.0', '1.3.6.1.2.1.1.6.0'];

                if (writableOids.includes(oid)) {
                    this.mib[oid] = value;
                    return 'SET OK';
                }

                return 'Error: OID is read-only or does not exist';
            }

            simulateTrap() {
                if (Math.random() < 0.1) {
                    const portOid = '1.3.6.1.2.1.2.2.1.8.2';
                    const oldStatus = this.portStatus[portOid];
                    const newStatus = oldStatus === 'up' ? 'down' : 'up';
                    this.portStatus[portOid] = newStatus;

                    return {
                        type: 'TRAP',
                        source: this.ip,
                        oid: '1.3.6.1.6.3.1.1.5.3',
                        message: `Port 2 (OID: ${portOid}) changed status to ${newStatus}`
                    };
                }
                return null;
            }
        }

        // --- Logging Function ---
        function logMessage(type, source, dest, content) {
            const timestamp = new Date().toISOString();
            let colorClass = 'text-gray-200';
            
            if (type.startsWith('GET')) colorClass = 'text-blue-400';
            if (type.startsWith('SET')) colorClass = 'text-yellow-400';
            if (type.startsWith('TRAP')) colorClass = 'text-red-400 font-bold';
            if (type.startsWith('SYSTEM')) colorClass = 'text-green-400 font-bold';

            const logEntry = document.createElement('div');
            logEntry.innerHTML = 
                `<span class="text-gray-500">[${timestamp}]</span> ` +
                `<span class="w-24 inline-block ${colorClass}">[${type}]</span> ` +
                `<span class="text-cyan-400">From:</span> ${source} ` +
                `<span class="text-cyan-400">To:</span> ${dest} | ` +
                `<span class="${colorClass}">${content}</span>`;
            
            logOutput.prepend(logEntry);
        }

        // --- Network Delay ---
        function getNetworkDelay() {
            const delay = parseInt(netDelayInput.value, 10);
            return isNaN(delay) || delay < 0 ? 0 : delay;
        }

        // --- Network Map Animation ---
        function flashMapElement(agentIp, type) {
            const managerEl = mapManager;
            const agentEl = document.getElementById(`map-agent-${agentIp}`);
            if (!agentEl) return;

            const managerBaseClass = mapManager.baseClass; 
            const agentBaseClass = agentEl.baseClass; 
            
            let flashClass = '';
            let vibrateClass = '';

            switch (type) {
                case 'get': 
                    flashClass = 'bg-blue-500 scale-110'; 
                    break;
                case 'set': 
                    flashClass = 'bg-yellow-500 scale-110 text-black'; 
                    break;
                case 'trap': 
                    flashClass = 'bg-red-600 border-red-400'; // Trap state class
                    vibrateClass = 'vibrate'; 
                    break;
                default: return;
            }

            const flashDuration = 150;

            if (type === 'get' || type === 'set') {
                // Request: Manager -> Agent
                managerEl.className = `${managerBaseClass} ${flashClass}`;
                setTimeout(() => {
                    managerEl.className = managerBaseClass;
                    agentEl.className = `${agentBaseClass} ${flashClass}`;
                    setTimeout(() => {
                        // Revert agent to base class *unless* it's in a trap state
                        if (!agentEl.className.includes('bg-red-600')) {
                           agentEl.className = agentBaseClass;
                        }
                    }, flashDuration);
                }, flashDuration);
            } else if (type === 'trap') {
                // Trap: Agent -> Manager
                // Agent turns red and vibrates, AND STAYS RED
                agentEl.className = `${agentBaseClass} ${flashClass} ${vibrateClass}`;
                
                // Manager flashes (border) and vibrates, then reverts
                // NEW: Make manager flash red completely, not just border
                managerEl.className = `${managerBaseClass} bg-red-600 text-white border-red-400 ${vibrateClass}`;
                
                setTimeout(() => {
                    // Revert manager after animation
                    managerEl.className = managerBaseClass;
                    // DO NOT revert agentEl. It stays red.
                    // Remove vibrate class from agent after animation
                    agentEl.className = `${agentBaseClass} ${flashClass}`;
                }, 600); // Vibrate duration
            }
        }

        // --- UI Update Functions ---
        function updateDeviceGrid(device) {
            const card = document.createElement('div');
            // Changed to match new dark theme
            card.className = 'bg-gray-900 p-3 rounded-lg shadow-md cursor-pointer hover:bg-gray-800 transition duration-150 border border-gray-700';
            card.innerHTML = `
                <div class="font-bold text-blue-400">${device.ip}</div>
                <div class="text-sm text-gray-400">${device.type}</div>
            `;
            // Click to log MIB
            card.onclick = () => {
                logMessage('SYSTEM', 'Manager', 'Manager', `--- MIB for ${device.ip} ---`);
                for (const [oid, value] of Object.entries(device.mib)) {
                    const val = typeof value === 'function' ? Math.floor(value()) : value;
                    logMessage('SYSTEM', 'Manager', 'Manager', `${oid} = ${val}`);
                }
                for (const [oid, status] of Object.entries(device.portStatus)) {
                    logMessage('SYSTEM', 'Manager', 'Manager', `${oid} = ${status}`);
                }
                logMessage('SYSTEM', 'Manager', 'Manager', `--- End MIB ---`);
            };
            deviceGrid.appendChild(card);
        }

        // This function now places agents in a circle around the center
        function updateNetworkMap(device, index, total) {
            const mapAgentEl = document.createElement('div');
            const isRouter = device.type === 'Router';
            
            // Define classes for circle and colors
            const agentTypeClass = isRouter 
                ? 'bg-blue-800 border-blue-500' 
                : 'bg-green-800 border-green-500';
            
            // Store baseClass on the element for animation reset. NO pulse class.
            mapAgentEl.baseClass = `w-20 h-20 rounded-full flex flex-col items-center justify-center text-center shadow-lg transition-all duration-150 border-2 ${agentTypeClass}`;
            mapAgentEl.className = mapAgentEl.baseClass;
            mapAgentEl.id = `map-agent-${device.ip}`; // Set ID for flashing
            mapAgentEl.innerHTML = `
                <div class="font-semibold text-sm text-gray-100">${device.ip.split('.').pop()}</div>
                <div class="text-xs text-gray-300">${device.type}</div>
            `;

            // --- Circular Positioning Logic ---
            const radius = 160; // Radius of the circle in pixels
            // Calculate angle. Subtract PI/2 to start at the top (12 o'clock)
            const angle = (index / total) * 2 * Math.PI - (Math.PI / 2); 
            const x = Math.cos(angle) * radius;
            const y = Math.sin(angle) * radius;

            // Set new positioning
            mapAgentEl.style.position = 'absolute';
            mapAgentEl.style.top = '50%';
            mapAgentEl.style.left = '50%';
            // translate(-50%, -50%) centers the element *then* translate(x, y) moves it
            mapAgentEl.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
            // --- End Positioning Logic ---

            mapAgentsContainer.appendChild(mapAgentEl);
        }

        // --- Simulation Logic ---
        function pollDevice(device, oid) {
            // --- NEW RESET LOGIC ---
            // Find the map element for this device
            const agentEl = document.getElementById(`map-agent-${device.ip}`);
            // If the element exists and is NOT in its base state (i.e., it's red from a trap)
            if (agentEl && agentEl.className !== agentEl.baseClass) {
                // Reset it to its base state (blue/green)
                agentEl.className = agentEl.baseClass;
            }
            // --- END NEW LOGIC ---

            const delay = getNetworkDelay();
            logMessage('GET', managerIP, device.ip, `Query: ${oid}`);
            flashMapElement(device.ip, 'get'); // Animate map for the new GET

            setTimeout(() => {
                const value = device.get(oid);
                logMessage('GET-RESPONSE', device.ip, managerIP, `OID: ${oid} = ${value}`);
            }, delay);
        }

        function startPolling() {
            if (pollingIntervalId) clearInterval(pollingIntervalId);

            const interval = parseInt(pollIntervalInput.value, 10);
            if (isNaN(interval) || interval < 500) {
                logMessage('SYSTEM', 'Manager', 'Manager', 'Error: Invalid polling interval. Must be >= 500ms.');
                return;
            }

            const oidsToPoll = oidsTextarea.value.split('\n').map(o => o.trim()).filter(o => o);
            if (oidsToPoll.length === 0) {
                logMessage('SYSTEM', 'Manager', 'Manager', 'Error: No OIDs specified to poll.');
                return;
            }

            logMessage('SYSTEM', 'Manager', 'Manager', `Starting polling every ${interval}ms...`);
            stopPollBtn.disabled = false;
            startPollBtn.disabled = true;
            startPollBtn.innerText = "Polling...";

            pollingIntervalId = setInterval(() => {
                for (const [ip, device] of devices.entries()) {
                    for (const oid of oidsToPoll) {
                        pollDevice(device, oid);
                    }
                    const trap = device.simulateTrap();
                    if (trap) {
                        logMessage(trap.type, trap.source, managerIP, trap.message);
                        flashMapElement(trap.source, 'trap'); // Animate trap
                    }
                }
            }, interval);
        }

        function stopPolling() {
            if (pollingIntervalId) {
                clearInterval(pollingIntervalId);
                pollingIntervalId = null;
                logMessage('SYSTEM', 'Manager', 'Manager', 'Polling stopped.');
                stopPollBtn.disabled = true;
                startPollBtn.disabled = false;
                startPollBtn.innerText = "Start Polling";
            }
        }

        // --- Event Listeners ---
        startSimBtn.addEventListener('click', () => {
            const numDevices = parseInt(numDevicesInput.value, 10);
            const prefix = agentPrefixInput.value;
            managerIP = managerIpInput.value;
            
            // Update Manager node: white, centered, and NO pulse
            mapManager.baseClass = 'w-24 h-24 rounded-full flex flex-col items-center justify-center text-center font-bold shadow-md transition-all duration-150 bg-white text-black border-2 border-gray-400 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2';
            mapManager.className = mapManager.baseClass;
            mapManager.innerHTML = `Manager<br><span class="text-xs font-normal">${managerIP}</span>`;

            devices.clear();
            deviceGrid.innerHTML = '';
            mapAgentsContainer.innerHTML = ''; // Clear map agents
            stopPolling();

            if (isNaN(numDevices) || numDevices <= 0 || numDevices > 100) {
                logMessage('SYSTEM', 'Manager', 'Manager', 'Error: Invalid number of devices (1-100).');
                return;
            }

            for (let i = 1; i <= numDevices; i++) {
                const ip = `${prefix}${100 + i}`;
                const type = i % 2 === 0 ? 'Switch' : 'Router';
                const device = new Device(ip, type);
                devices.set(ip, device);
                
                // Update both UI sections
                updateDeviceGrid(device);
                // Pass index (i-1) and total (numDevices) for circular layout
                updateNetworkMap(device, i - 1, numDevices); 
            }
            
            logMessage('SYSTEM', 'Manager', 'Manager', `Created ${numDevices} devices.`);
            startPollBtn.disabled = false;
            sendSetBtn.disabled = false;
        });

        startPollBtn.addEventListener('click', startPolling);
        stopPollBtn.addEventListener('click', stopPolling);
        
        sendSetBtn.addEventListener('click', () => {
            const ip = setIpInput.value;
            const oid = setOidInput.value;
            const value = setValueInput.value;
            const device = devices.get(ip);

            if (!device) {
                logMessage('SYSTEM', 'Manager', 'Manager', `Error: Device with IP ${ip} not found.`);
                return;
            }
            if (!oid || !value) {
                logMessage('SYSTEM', 'Manager', 'Manager', 'Error: OID and Value must be specified for SET.');
                return;
            }
            
            const delay = getNetworkDelay();
            logMessage('SET', managerIP, ip, `Request: ${oid} = ${value}`);
            flashMapElement(ip, 'set'); // Animate map

            setTimeout(() => {
                const response = device.set(oid, value);
                logMessage('SET-RESPONSE', ip, managerIP, `Response: ${response}`);
            }, delay);
        });

        clearLogBtn.addEventListener('click', () => {
            logOutput.innerHTML = '';
            logMessage('SYSTEM', 'Manager', 'Manager', 'Log cleared.'); // Add feedback
        });

    </script>
</body>
</html>


